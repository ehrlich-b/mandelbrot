# Codebase Audit: December 2024

> **TL;DR:** The DD shader renders solid black at deep zoom. ~70% of the codebase is dead code that was never integrated. The project needs to fix one thing (DD precision) before anything else.

---

## Executive Summary

**The core issue is simple: The DD (double-double) precision shader renders solid black at deep zoom levels, but this has been obscured by layers of aspirational architecture that was never integrated.**

The TODO.md claims many features are complete, but E2E tests reveal the fundamental problem: at deep zoom levels (scale < 5e-6), the renderer outputs solid black instead of fractal detail.

---

## What Actually Works

| Feature | Status | Evidence |
|---------|--------|----------|
| Standard WebGL2 rendering | Works | Tests pass at normal zoom |
| Color palettes (11 palettes) | Works | Visual confirmation |
| Anti-aliasing toggle | Works | Code is integrated |
| Input handling | Works | Pan/zoom/touch all work |
| State persistence | Works | localStorage integration |
| Precision switching detection | Works | HUD correctly shows "DD" mode |

---

## What Does NOT Work

| Feature | Claimed in TODO.md | Reality |
|---------|---------|---------|
| DD Precision Deep Zoom | "Complete" | **Renders solid black** |
| Progressive Rendering | "Complete" | Disabled by default (`progressiveEnabled = false`) |
| Tile-based Rendering | "Complete" | **Never used** (default: `renderMode = 'fullframe'`) |
| Web Workers | "Complete" | **Never initialized** in main flow |
| WASM Arbitrary Precision | "Complete" | **Never called** by any renderer |
| Perturbation Theory | "Complete" | **Dead code** (PerturbationRenderer never instantiated) |

---

## Evidence: DD Shader Failure

From E2E test run (`npm run test:e2e`):

```
Testing deep-dd at scale 1e-7
Scale 1e-7: precision = dd
Solid color check: {
  firstPixel: { r: 0, g: 0, b: 0 },
  totalPixels: 2500,
  sameCount: 2500,
  solidColorRatio: 1,
  isLikelySolidColor: true
}
WARNING: Appears to be rendering solid color - DD precision may not be working correctly
```

At scale `1e-7` (deep DD territory), **100% of sampled pixels are identical black**. The fractal detail that should exist is completely missing.

### Test Results Summary

- **Chromium**: 8 pass, 4 fail (DD-related failures)
- **Firefox**: All fail (WebGL2 issues)
- **WebKit**: All fail (WebGL2 issues)
- **Mobile Chrome**: 10 pass, 3 fail (DD-related failures)

The failures are NOT test infrastructure issues - they correctly detect that the DD renderer outputs incorrect (solid black) results.

---

## Dead Code Inventory

### Never-Executed Code (~3,500 lines, ~70% of codebase)

| File/Directory | Lines | Status | Why Dead |
|----------------|-------|--------|----------|
| `tiles/TileManager.ts` | ~400 | Dead | `renderMode` defaults to `'fullframe'` |
| `tiles/TileCompositor.ts` | ~350 | Dead | Only used by TileRenderer |
| `tiles/TileRenderer.ts` | 268 | Dead | Never set as render mode |
| `tiles/FrameReprojector.ts` | ~300 | Dead | Part of tile system |
| `tiles/TileCache.ts` | ~200 | Dead | Part of tile system |
| `tiles/ViewportPredictor.ts` | ~150 | Dead | Part of tile system |
| `tiles/types.ts` | ~200 | Dead | Part of tile system |
| `workers/WorkerPool.ts` | ~300 | Dead | Never initialized |
| `workers/tile.worker.ts` | 370 | Dead | No work dispatched |
| `workers/types.ts` | ~100 | Dead | Worker types |
| `render/PerturbationRenderer.ts` | 440 | Dead | Never instantiated |
| `render/PrecisionManager.ts` | ~100 | Dead | Different from inline PrecisionManager in WebGLRendererDD |
| `wasm/ReferenceOrbit.ts` | 315 | Dead | Only used by dead PerturbationRenderer |
| `wasm/BigFloatWasm.ts` | ~200 | Dead | Never imported |
| `wasm/BigFloatJS.ts` | ~250 | Dead | Never imported |
| `wasm/bigfloat.c` | ~500 | Dead | WASM compiled but never called |
| `shaders/fragment-perturbation.glsl` | 320 | Dead | Used by dead PerturbationRenderer |
| `shaders/dd-arithmetic.glsl` | 335 | Dead | Functions duplicated in fragment-dd.glsl |

### Code That Actually Runs

| File | Lines | Purpose |
|------|-------|---------|
| `MandelbrotViewer.ts` | 503 | Main orchestrator |
| `render/WebGLRendererDD.ts` | 562 | Primary renderer |
| `render/WebGLRenderer.ts` | 429 | Base renderer (partially used) |
| `shaders/fragment.glsl` | 451 | Standard precision shader |
| `shaders/fragment-dd.glsl` | 518 | DD precision shader (**BROKEN**) |
| `shaders/vertex.glsl` | ~20 | Vertex shader |
| `input/InputHandler.ts` | ~300 | Mouse/touch/keyboard |
| `ui/HUD.ts` | ~200 | Heads-up display |
| `ui/Controls.ts` | ~300 | UI controls |
| `state/store.ts` | ~200 | State management |
| `math/dd.ts` | ~150 | TypeScript DD arithmetic |

---

## Architecture: Claimed vs Reality

### Claimed Architecture (from TODO.md)
```
MandelbrotViewer
├── WebGLRendererDD (auto-switch standard/DD)
├── TileRenderer (with tile cache, workers)
│   ├── TileManager → WorkerPool → WASM
│   └── TileCompositor
├── PerturbationRenderer (for extreme zoom)
│   └── ReferenceOrbit (WASM arbitrary precision)
└── FrameReprojector (instant pan/zoom feedback)
```

### Actual Architecture
```
MandelbrotViewer
└── WebGLRendererDD
    ├── standardProgram → fragment.glsl (works)
    └── ddProgram → fragment-dd.glsl (renders black)
```

Everything else exists as files but is **never instantiated or connected**.

---

## The DD Shader Problem

### Location
`apps/web/src/render/shaders/fragment-dd.glsl`

### Symptoms
- Precision correctly switches at scale < 5e-6
- HUD shows "DD" mode
- Shader compiles without errors
- Output is solid black (or solid color matching iteration 0)

### Likely Culprits

1. **Coordinate Generation** (`pixelToComplexDD()` at line 436-469)
   - Complex chain of DD operations
   - Possible precision loss or incorrect calculation
   - Result: all pixels get same/similar coordinates

2. **Scale Uniform** (`u_scale_dd`)
   - Passed as vec2 from JS
   - May not be correctly decomposed into hi/lo parts
   - Result: scale effectively zero or wrong

3. **Center Uniform** (`u_center_dd`)
   - Passed as vec4 from JS
   - Same potential issue as scale

4. **Aspect Ratio Handling**
   - Standard shader: `(v_texCoord - 0.5) * aspectRatio`
   - DD shader: Different calculation path
   - May produce different viewport mapping

### Key Code Path

```glsl
// In fragment-dd.glsl main():
if (u_use_dd_precision) {
    vec4 c_dd = pixelToComplexDD();  // <-- Likely broken here
    mu = mandelbrotDD(c_dd);
} else {
    // Standard path works fine
    vec2 c = u_center + uv * u_scale;
    mu = mandelbrot(c);
}
```

---

## Root Cause Analysis

The project exhibits a classic anti-pattern: **building horizontal breadth before vertical depth**.

### Timeline of Issues

1. Standard precision worked
2. DD shader written but not validated visually
3. Tile system built "on top" of DD (never testing DD itself)
4. Worker infrastructure added
5. WASM/perturbation added
6. Each layer marked "complete" without integration testing
7. E2E tests written but failures explained away as "test infrastructure issues"

### The TODO.md Misdirection

The "Known Issues" section frames test failures as pixel-reading problems:

> **Root cause:** Tests use `canvas.getContext('2d').getImageData()` on a WebGL canvas with `preserveDrawingBuffer: false`. This returns empty/zero data.

But the actual test uses `gl.readPixels()` which works fine - it correctly reads the solid black pixels that the DD shader outputs.

---

## Recommended Fix Path

### Phase 1: Prove the Problem (30 min)

1. Add debug output to DD shader
2. Verify uniforms are received correctly
3. Output debug color based on coordinate values
4. Confirm whether issue is coordinate generation or iteration

### Phase 2: Fix DD Shader (2-4 hours)

1. Simplify `pixelToComplexDD()` - compare directly to standard path
2. Add step-by-step validation
3. Test at one known location (e.g., Seahorse Valley at 1e-8)
4. Verify visual output matches expected fractal structure

### Phase 3: Remove Dead Code (1 hour)

Delete until proven needed:
- `tiles/` directory
- `workers/` directory
- `wasm/` directory (keep if needed for future)
- `render/PerturbationRenderer.ts`
- `render/PrecisionManager.ts`
- `shaders/fragment-perturbation.glsl`
- `shaders/dd-arithmetic.glsl`

### Phase 4: Validate and Document (1 hour)

1. Update TODO.md with actual status
2. Create visual test cases with screenshots
3. Document working zoom range

---

## Success Criteria

The DD shader is "fixed" when:

1. Zooming to scale 1e-8 shows fractal detail (not solid color)
2. E2E test `should detect debug colors in DD mode` passes
3. Visual continuity exists when crossing precision threshold (5e-6)
4. Zooming in/out through the threshold shows no jarring transition

---

## Files to Examine First

1. `apps/web/src/render/WebGLRendererDD.ts:353-374` - `setDDUniforms()`
2. `apps/web/src/render/shaders/fragment-dd.glsl:436-469` - `pixelToComplexDD()`
3. `apps/web/src/math/dd.ts` - TypeScript DD arithmetic (for comparison)

---

## Appendix: Test Commands

```bash
# Run all E2E tests
npm run test:e2e

# Run only deep zoom tests
npx playwright test tests/e2e/deep-zoom.spec.ts

# Run with visible browser
npx playwright test --headed

# Run specific test
npx playwright test -g "should detect debug colors"

# Start dev server for manual testing
npm run dev
# Then navigate to http://localhost:5173
# Open console, run: mandelbrot.setViewport({scale: 1e-8})
```
